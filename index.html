<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minesweeper ‚Äî –ú–∞–≥–º–∞ –ù–µ–æ–Ω</title>
<style>
  :root{
    --bg-1: #070306;
    --bg-2: #13040a;
    --accent-1: #ff8b1a;
    --accent-2: #ff3b00;
    --accent-3: #ffd07a;
    --neon: rgba(255,100,30,0.12);
    --panel: rgba(255,255,255,0.04);
    --cell-size: 36px;       /* default for easy */
    --min-cell: 14;          /* minimum cell size in px */
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#fff}
  body{display:flex;flex-direction:column;align-items:center;padding:14px;gap:12px}

  /* top UI */
  .top{
    width:100%;max-width:1100px;display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  h1{margin:0;font-size:1.15rem;letter-spacing:.6px;text-shadow:0 8px 30px rgba(255,80,10,0.04)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select{
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;backdrop-filter: blur(2px);
  }
  button:active{transform:scale(.98)}
  .diffs{display:flex;gap:6px}
  .diffs button{padding:6px 10px;border-radius:10px;background:transparent}
  .diffs button.selected{
    background:linear-gradient(90deg,var(--accent-1),var(--accent-2));
    color:#120202;
    box-shadow:0 8px 30px rgba(255,80,20,0.16);
  }
  .hud{display:flex;gap:12px;align-items:center;background:linear-gradient(180deg, rgba(0,0,0,0.2), rgba(255,255,255,0.02));padding:8px;border-radius:10px}
  .stat{font-weight:700;color:var(--accent-3)}
  .stat .value{margin-left:6px;color:#fff;text-shadow:0 6px 18px rgba(255,90,20,0.08)}

  /* board container */
  .board-wrap{width:100%;max-width:1100px;background:linear-gradient(180deg, rgba(10,3,2,0.2), rgba(0,0,0,0.45));padding:12px;border-radius:14px;display:flex;justify-content:center;overflow:hidden;position:relative}
  #board{display:grid;gap:6px;padding:6px;border-radius:10px;background:linear-gradient(180deg,#120406,#0b0203);touch-action:none;transition:transform .14s ease}

  /* cells - neon magma aesthetic */
  .cell{
    width:var(--cell-size);
    height:var(--cell-size);
    background:linear-gradient(180deg,#0d0606,#170707);
    border-radius:8px;
    box-shadow: inset 0 -6px 14px rgba(0,0,0,0.7), 0 8px 18px rgba(0,0,0,0.6);
    display:flex;align-items:center;justify-content:center;
    font-weight:900;user-select:none;cursor:pointer;position:relative;overflow:visible;
    transition:transform .08s ease, box-shadow .12s ease, background .18s ease;
    color:#000; /* numbers black as requested */
  }

  /* inner glow lines to emulate molten cracks; use pseudo-element */
  .cell::after{
    content:''; position:absolute; inset:0; border-radius:8px;
    background: radial-gradient(circle at 10% 10%, rgba(255,80,30,0.06), transparent 6%),
                radial-gradient(circle at 90% 90%, rgba(255,120,40,0.04), transparent 6%);
    mix-blend-mode:screen; pointer-events:none;
  }

  .cell:hover{ transform:translateY(-6px); box-shadow: 0 18px 40px rgba(255,120,40,0.06); }
  .cell.revealed{
    background: linear-gradient(180deg,#ffe8c8,#ffd9b0);
    box-shadow:none; transform:none;
  }

  /* reveal numbers with neon-like glow */
  .num{
    font-weight:900;
    color:#0b0b0b;
    text-shadow: 0 8px 22px rgba(255,120,40,0.65);
    font-size:calc(var(--cell-size) * 0.54);
  }

  /* flagged / mine */
  .cell.flagged{ background:linear-gradient(180deg,#2f1208,#3b150a); color:#fff; }
  .cell.flagged::before{ content: "üö©"; font-size:1em; transform:translateY(-1px); position:relative; z-index:2; }
  .cell.mine{ background:linear-gradient(180deg,#3a0a05,#56120a); color:#fff; }
  .cell.mine::before{ content:""; position:absolute; width:60%; height:60%; border-radius:6px; background: radial-gradient(circle at 30% 20%, rgba(255,190,60,0.95), rgba(255,80,20,0.9) 12%, transparent 35%); box-shadow:0 0 40px rgba(255,120,40,0.6); transform:translateY(0); z-index:0; }

  /* small X when a wrong flag */
  .cell.wrong{ background:#f2d1c0; color:#000; }

  /* particle for explosion */
  .particle{
    position:fixed; pointer-events:none; border-radius:2px; z-index:9999; will-change: transform, opacity;
    box-shadow: 0 6px 18px rgba(255,100,30,0.25);
  }

  /* shake (on board-wrap element) */
  .shake{ animation:shakeBig .72s cubic-bezier(.36,.07,.19,.97); }
  @keyframes shakeBig{
    0%{ transform:translate(0,0) }
    10%{ transform:translate(-10px,6px) rotate(-0.5deg) }
    20%{ transform:translate(10px,-8px) rotate(0.6deg) }
    30%{ transform:translate(-12px,-6px) rotate(-0.9deg) }
    40%{ transform:translate(12px,6px) rotate(0.8deg) }
    50%{ transform:translate(-6px,6px) rotate(-0.4deg) }
    60%{ transform:translate(6px,-6px) rotate(0.4deg) }
    70%{ transform:translate(-4px,4px) rotate(-0.2deg) }
    100%{ transform:translate(0,0) rotate(0) }
  }

  /* result bar bottom */
  #resultBar{
    position:fixed; left:50%; transform:translateX(-50%) translateY(120%); bottom:18px; padding:12px 18px; border-radius:12px;
    background:linear-gradient(90deg,#6b0f00,#2b0500); color:#ffd7a8; font-weight:900; box-shadow:0 18px 50px rgba(0,0,0,0.6); opacity:0; transition:transform .35s, opacity .25s; z-index:120;
  }
  #resultBar.show{ transform:translateX(-50%) translateY(0); opacity:1; }

  /* responsive tweaks */
  @media (max-width:980px){ .board-wrap{ padding:8px } }
  @media (max-width:720px){
    :root{ --cell-size: 28px; }
    .top{ flex-direction:column; align-items:flex-start; gap:8px; }
  }
  @media (max-width:420px){
    :root{ --cell-size: 24px; }
  }
</style>
</head>
<body>

  <div class="top">
    <h1>üî• Minesweeper ‚Äî –ú–∞–≥–º–∞ –ù–µ–æ–Ω</h1>

    <div style="display:flex;gap:12px;align-items:center">
      <div class="controls">
        <div class="diffs" id="diffs" role="tablist" aria-label="–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏">
          <button data-diff="easy" class="selected">–õ–µ–≥–∫–æ</button>
          <button data-diff="medium">–°—Ä–µ–¥–Ω–µ</button>
          <button data-diff="hard">–°–ª–æ–∂–Ω–æ</button>
        </div>
        <button id="newBtn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
      </div>

      <div class="hud" aria-hidden="false" style="margin-left:8px">
        <div class="stat">üí£ <span id="minesLeft" class="value">0</span></div>
        <div class="stat">üö© <span id="flagsCount" class="value">0</span></div>
        <div class="stat">‚è± <span id="timer" class="value">0</span>s</div>
      </div>
    </div>
  </div>

  <div class="board-wrap" id="boardWrap">
    <div id="board" role="grid" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ"></div>
  </div>

  <div id="resultBar" role="status" aria-live="polite"></div>

<script>
/* ===========================
   Game configuration & state
   =========================== */
const DIFF = {
  easy:   { rows:9, cols:9,  mines:10, cellPx:36 },
  medium: { rows:14, cols:14, mines:30, cellPx:28 },
  hard:   { rows:16, cols:24, mines:70, cellPx:20 }
};

let current = 'easy';
let rows = DIFF[current].rows, cols = DIFF[current].cols, minesTotal = DIFF[current].mines;
let board = []; // matrix of cells: {mine, rev, flag, adj, el}
let firstClick = true;
let gameState = 'playing';
let flagsCount = 0;
let minesLeft = minesTotal;
let timer = 0, timerId = null;

const boardEl = document.getElementById('board');
const boardWrap = document.getElementById('boardWrap');
const minesLeftEl = document.getElementById('minesLeft');
const flagsCountEl = document.getElementById('flagsCount');
const timerEl = document.getElementById('timer');
const resultBar = document.getElementById('resultBar');

/* ===============
   Audio (WebAudio)
   =============== */
const audioCtx = typeof AudioContext !== 'undefined' ? new AudioContext() : null;
function playClick(){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = 800;
  g.gain.value = 0.02;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.07);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
  setTimeout(()=>o.stop(), 160);
}
function playFlag(){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'triangle';
  o.frequency.value = 400;
  g.gain.value = 0.02;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.12);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2);
  setTimeout(()=>o.stop(), 220);
}
function playBoom(){
  if(!audioCtx) return;
  const dura = 0.35;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  const b = audioCtx.createBiquadFilter();
  o.type = 'sawtooth';
  o.frequency.value = 120;
  b.type = "lowpass"; b.frequency.value = 800;
  g.gain.value = 0.08;
  o.connect(b); b.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + dura);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dura);
  setTimeout(()=>o.stop(), (dura+0.05)*1000);
}

/* ============
   HUD helpers
   ============ */
function updateHUD(){
  minesLeftEl.textContent = minesLeft;
  flagsCountEl.textContent = flagsCount;
  timerEl.textContent = timer;
}

/* ============
   Timer
   ============ */
function startTimer(){ if(timerId) return; timer = 0; timerEl.textContent = timer; timerId = setInterval(()=>{ timer++; timerEl.textContent = timer; }, 1000); }
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId = null; } }

/* =================================
   Board sizing & fit to viewport
   ================================= */
function applySizing(){
  const cfg = DIFF[current];
  rows = cfg.rows; cols = cfg.cols; minesTotal = cfg.mines;
  minesLeft = minesTotal;
  document.documentElement.style.setProperty('--cell-size', cfg.cellPx + 'px');
}

/* try to scale board so it fits both width & height, min cell size preserved */
function fitBoard(){
  requestAnimationFrame(()=>{
    const cfg = DIFF[current];
    const baseCell = cfg.cellPx;
    const gap = parseFloat(getComputedStyle(boardEl).gap) || 6;
    const neededW = cols * (baseCell + gap);
    const neededH = rows * (baseCell + gap);
    const wrapRect = boardWrap.getBoundingClientRect();
    const availW = Math.min(wrapRect.width - 8, window.innerWidth - 32);
    const availH = Math.max(window.innerHeight - wrapRect.top - 120, 120);
    let scale = Math.min(availW / neededW, availH / neededH, 1);
    const minCell = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--min-cell')) || 14;
    const minScale = minCell / baseCell;
    scale = Math.max(scale, minScale);
    boardEl.style.transform = `scale(${scale})`;
    boardEl.style.transformOrigin = 'top center';
  });
}

/* ================
   Init / New game
   ================ */
function initGame(){
  stopTimer();
  firstClick = true;
  gameState = 'playing';
  flagsCount = 0;
  minesLeft = minesTotal;
  timer = 0;
  updateHUD();
  resultBar.classList.remove('show'); resultBar.textContent = '';

  board = [];
  boardEl.innerHTML = '';
  boardEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

  for(let r=0;r<rows;r++){
    const row = [];
    for(let c=0;c<cols;c++){
      const el = document.createElement('div');
      el.className = 'cell';
      el.dataset.r = r; el.dataset.c = c;
      el.tabIndex = 0;

      // cracks overlay
      const crack = document.createElement('div');
      crack.className = 'cracks';
      el.appendChild(crack);

      el.addEventListener('click', ()=> onClickCell(r,c));
      el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); onFlag(r,c); });
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onClickCell(r,c); if(e.key===' '){ e.preventDefault(); onFlag(r,c); } });

      boardEl.appendChild(el);
      row.push({ mine:false, rev:false, flag:false, adj:0, el });
    }
    board.push(row);
  }

  fitBoard();
}

/* place mines but avoid initial 3x3 around first click */
function placeMines(avoidR, avoidC){
  let placed = 0;
  while(placed < minesTotal){
    const r = Math.floor(Math.random()*rows);
    const c = Math.floor(Math.random()*cols);
    if(Math.abs(r-avoidR) <= 1 && Math.abs(c-avoidC) <= 1) continue;
    if(board[r][c].mine) continue;
    board[r][c].mine = true; placed++;
  }
  // adjacency
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(board[r][c].mine) continue;
      let cnt = 0;
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        const nr=r+dr, nc=c+dc;
        if(nr>=0 && nr<rows && nc>=0 && nc<cols && board[nr][nc].mine) cnt++;
      }
      board[r][c].adj = cnt;
    }
  }
}

/* ==========================
   Click / Flag / Reveal logic
   ========================== */
function onClickCell(r,c){
  if(gameState !== 'playing') return;
  const o = board[r][c];
  if(o.rev || o.flag) return;

  if(firstClick){
    firstClick = false;
    placeMines(r,c);
    startTimer();
  }

  if(o.mine){
    // explosion
    triggerStrongExplosion(r,c);
    revealAllMines();
    lose();
    return;
  }

  floodReveal(r,c);
  checkWin();
  playClick();
}

function onFlag(r,c){
  if(gameState !== 'playing') return;
  const o = board[r][c];
  if(o.rev) return;

  o.flag = !o.flag;
  if(o.flag){
    flagsCount++; o.el.classList.add('flagged'); o.el.textContent = 'üö©';
    playFlag();
  } else {
    flagsCount = Math.max(0, flagsCount - 1);
    o.el.classList.remove('flagged'); o.el.textContent = '';
  }
  minesLeft = Math.max(0, minesTotal - flagsCount);
  updateHUD();
  checkWin();
}

function floodReveal(r,c){
  const o = board[r][c];
  if(o.rev || o.flag) return;
  o.rev = true;
  o.el.classList.add('revealed');

  if(o.adj > 0){
    o.el.innerHTML = `<span class="num">${o.adj}</span>`;
    return;
  }

  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
    const nr=r+dr, nc=c+dc;
    if(nr>=0 && nr<rows && nc>=0 && nc<cols) floodReveal(nr,nc);
  }
}

/* reveal all mines on loss; ensure only one bomb symbol per mine cell */
function revealAllMines(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const o = board[r][c];
      if(o.mine){
        o.rev = true;
        o.el.classList.add('revealed','mine');
        o.el.textContent = 'üí£';
      } else if(o.flag && !o.mine){
        o.el.classList.add('revealed','wrong');
        o.el.textContent = '‚úñ';
      }
    }
  }
}

/* ======================
   Win / Lose
   ====================== */
function checkWin(){
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const o = board[r][c];
    if(!o.mine && !o.rev) return;
  }
  win();
}

function win(){
  gameState = 'win';
  stopTimer();
  showResult(`üéâ –ü–û–ë–ï–î–ê! ${timer}s`);
  // small soft glow on board
  boardWrap.animate([{filter:'brightness(1)'},{filter:'brightness(1.12)'}],{duration:420,fill:'forwards'});
}

function lose(){
  gameState = 'lose';
  stopTimer();
  showResult('üí• –ü–û–†–ê–ñ–ï–ù–ò–ï');
  playBoom();
}

/* shows bottom result */
function showResult(text){
  resultBar.textContent = text;
  resultBar.classList.add('show');
  setTimeout(()=> resultBar.classList.remove('show'), 6000);
}

/* ====================
   Strong explosion FX
   ==================== */
function triggerStrongExplosion(r,c){
  // ensure only one bomb icon at that cell
  const o = board[r][c];
  o.el.classList.add('revealed','mine');
  o.el.textContent = 'üí£';

  // center position
  const rect = o.el.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;

  // play boom sound
  playBoom();

  // heavy shake of boardWrap
  boardWrap.classList.add('shake');
  setTimeout(()=> boardWrap.classList.remove('shake'), 720);

  // particle burst
  const density = current === 'easy' ? 40 : current === 'medium' ? 70 : 110;
  const attempts = Math.floor(density * 1.6);

  for(let i=0;i<attempts;i++){
    // skip some for medium/hard -> creates gaps
    if(current !== 'easy' && Math.random() < 0.45) continue;

    const p = document.createElement('div');
    p.className = 'particle';
    // lava palette
    const palette = ['#ff8b1a','#ff3b00','#ffcf6b','#ff6b00','#b32a00'];
    p.style.background = palette[Math.floor(Math.random()*palette.length)];
    const size = (Math.random()*8 + 6) * (current==='hard' ? 0.85 : current==='medium' ? 0.95 : 1.0);
    p.style.width = p.style.height = size + 'px';
    const jitterX = (Math.random()*12 - 6);
    const jitterY = (Math.random()*12 - 6);
    p.style.left = (cx + jitterX) + 'px';
    p.style.top = (cy + jitterY) + 'px';
    document.body.appendChild(p);

    // travel vector, biased upward, random distance
    const angle = Math.random() * Math.PI * 2;
    const baseDistance = current === 'hard' ? 360 : current === 'medium' ? 260 : 160;
    const distance = (Math.random() * baseDistance) + (current==='hard' ? 40 : 20);
    const tx = Math.cos(angle) * distance + (Math.random()*40-20);
    const ty = Math.sin(angle) * distance - (Math.random()*80 + 20);

    p.animate([
      { transform: 'translate(0,0) scale(1)', opacity: 1 },
      { transform: `translate(${tx}px, ${ty}px) scale(0.28)`, opacity: 0 }
    ], {
      duration: 600 + Math.random()*800,
      easing: 'cubic-bezier(.2,.9,.2,1)',
      fill: 'forwards'
    });

    // remove after some time
    setTimeout(()=> { try{ p.remove(); }catch(e){} }, 1600 + Math.random()*800);
  }

  // screen flash ripple
  const flash = document.createElement('div');
  flash.style.position = 'fixed';
  flash.style.left = '0'; flash.style.top = '0'; flash.style.right = '0'; flash.style.bottom = '0';
  flash.style.background = 'radial-gradient(circle at center, rgba(255,160,60,0.14), rgba(0,0,0,0))';
  flash.style.pointerEvents = 'none'; flash.style.zIndex = 9998;
  document.body.appendChild(flash);
  setTimeout(()=> flash.style.transition = 'opacity .45s', 20);
  setTimeout(()=> { flash.style.opacity = '0'; setTimeout(()=> flash.remove(), 480); }, 120);
}

/* =====================
   UI bindings & init
   ===================== */
document.getElementById('newBtn').addEventListener('click', ()=> initGame());
document.querySelectorAll('#diffs button').forEach(b=>{
  b.addEventListener('click', ()=> { setDifficulty(b.dataset.diff); });
});

function setDifficulty(diff){
  current = diff;
  document.querySelectorAll('#diffs button').forEach(b=> b.classList.toggle('selected', b.dataset.diff === diff));
  applySizing();
  initGame();
  fitBoard();
}

/* handle resizing */
window.addEventListener('resize', fitBoard);

/* expose small helpers for debugging */
window._ms = { setDifficulty, initGame, board };

/* initial */
applySizing();
initGame();
fitBoard();

</script>
</body>
</html>
